# Flink 中的类加载



## 概述

### Flink运行中用到代码(字节码)的分类

- Java Classpath
  - JDK 库
  - flink/lib目录下的代码.
- Flink插件类组件
  - flink/plugins 目录下的类
- 动态的用户代码
  - 动态提交的job application jar包中的类

### 类加载器

- AppClassLoader

  用于加载java classpath类型的代码

- FlinkUserCodeClassLoader

  用于加载动态的用户代码

### 不用的部署模式类加载的区别

#### session 模式

​	JobManager 和TaskManager 和flink框架下(lib/ plugin/)的代码都作为java class类型的代码,由`AppClassLoader`负责加载

​	通过rest/cli 动态提交的类 由`FlinkUserCodeClassLoadder`加载

#### Application模式

- Standalone/Kubernetes 部署

  用户的jar文件(flink 启动命令中和flink usrlib/目录)由FlinkUserClassLadder进行动态加载

- Yarn 部署

  默认情况下,用户jar将会包含在系统的classpath中,由AppClassLoader负责加载.

  当设置了`yarn.classpath.include-user-jar=disable`后,flink将会在user classpath中包含用户jar文件,并使用`FlinkUserCodeClassLoader`加载

  | 代码分类\部署模式 | Session Mode             | Application Mode                    |
  | ----------------- | ------------------------ | ----------------------------------- |
  | Java Classpath    | AppClassLoder            | FlinkUserCodeClassLoader            |
  | Dynamic User Code | FlinkUserCodeClassLoader | AppClassLoder(通过设置后,FUCCL负责) |

  

### 类加载的顺序

​	

​	从加载层级结构上说,AppClassLoader 是 FlinkUserCodeClassLoader 的父级

​	在非flink环境下,jvm 会优先加载父级加载器

​	但是在flink中,flink会倒转类加载器的顺序,flink会优先加载动态类加载,如果该类不属于动态加载器中的类时,才会使用父级的加载器.



好处是plugin和job 可以使用与flink运行时不同版本的库

比如说, flink运行时(taskmanager) 和job 都使用了json序类化库,且版本不同时,那么通过类加载器倒置后,在运行job时将优先使用job中依赖的版本.



### 避免动态加载用户代码

将不需要动态加载的代码放到 flink集群下的lib目录下.



### 手动进行用户代码的类加载

通过能访问到job相关类的类加载器进行实现

通过使用RichFunction,然后通过`getRuntimeContext().getUserCodeClassLoader()`访问用户代码的类加载器.



### 卸载用户代码中动态加载的类

当TaskManager启动或重启时会加载指定的任务代码,如果这些被加载的类不能卸载,那么就有可能引起内存泄露，因为被加载的类可能会随时间不断被加载累积。

#### 类泄露QA：

- *Lingering Threads*: 确保应用代码的函数/sources/sink关闭了所有线程。延迟关闭的线程不仅自身消耗资源，同时会因为占据对象引用，从而阻止垃圾回收和类的卸载。

- *Interners*: 避免缓存超出function/sources/sinks生命周期的特殊结构中的对象。比如Guava的Interner，或是Avro的序列化器中的类或对象。
- *JDBC*: JDBC驱动会在用户类加载器之外泄漏引用。为了确保这些类只被加载一次，您可以将驱动JAR包放在Flink的`lib/`目录下，或者将驱动类通过[`classloader.parent-first-patterns-additional`](https://nightlies.apache.org/flink/flink-docs-release-1.16/zh/docs/deployment/config/#classloader-parent-first-patterns-additional)加到父级优先加载类的列表中。



释放用户代码类加载器的钩子（hook）可以帮助卸载动态加载的类。

释放类加载器的钩子可以通过`RuntimeContext.registerUserCodeClassLoaderReleaseHookIfAbsent()`方法进行注册。



